---
show: step
version: 1.0
enable_checker: true
---

# HTTP 网络编程实现

## 实验介绍

本实验主要介绍基于 Go 语言如何用 Socket 编程知识实现并发通讯服务的案例，从而让大家巩固下前面所学的知识，达到学有所用的效果。另外本实验要求需要有 Go 语言的基础，对 Go 语言基本语法有一定的了解。

#### 知识点

- http 协议介绍
- web 工作方式
- 地址 URL 说明
- http 报文解析
- http 编程实现

## http 协议介绍

#### http 是什么

我们平时所说的 http 其实是指网络七层模型中应用层的 http 协议，也叫超文本传输协议（HTTP，HyperText Transfer Protocol)。既然是协议，那么它就是一种规范或者说是一种规则，它详细规定了浏览器和万维网服务器之间的相互通信。

平时上网使用的浏览器，打开网页搜索内容时，其实就是发起一个 http 请求到服务器上指定端口，比如，我们打开网页在百度搜索“http 协议”时，就会向百度搜索引擎服务器发起 http 请求，我们通常称发起请求的一端（浏览器）为客户端，响应或返回请求的一端称为服务端（服务器）。当然这里只是简单的说明了下，实际上客户端和服务端的通讯、数据传输要负责的多，往往在客户端和服务器端中间可能存在多个“中间层”，比如代理服务器、网关等。所以如果要提高客户端和服务器端之间的并发处理能力，可以从中间层入手，一般是优化网关（比如 ngnix），或者使用隧道优化技术等。

通常情况下，由客户端发起一个 http 请求，创建一个到服务器端的 TCP 连接，可以指定端口，没有指定端口时，一般是默认使用 80 端口，当然是需要服务器端提前监听该端口，客户端才能创建连接成功，即服务器端需要运行监听那个端口的程序，等待客户端请求连接的到来。一旦收到请求，服务器端就会向客户端返回一个状态，比如"HTTP/1.1 200 OK"，以及返回的内容，如请求的文件、错误消息等。

## web 工作方式（http 工作流程及原理）

前面说到，http 协议规定了浏览器和万维网服务器之间是怎样进行通信的，也就是说在应用层定义了客户端如何向服务器端发起请求，以及服务器端如何把响应数据返回送给客户端。简单来说 http 协议采用了请求/响应的模型。

以下是 http 从客户端发起请求到服务器端响应请求的简要步骤：

1. 客户端向服务器端发起建立连接的请求；
2. 服务器端接受请求并返回 http 响应；
3. 客户端处理服务器端响应的信息；
4. 数据处理完后，释放 tcp 连接，若请求头的 connection 模式设置为了 close，则服务器主动关闭 tcp 连接，客户端被动关闭连接；若 connection 模式设置为了 keepalive，则该连接会保持一段时间，在该时间内可以继续使用该连接。

我们来看下，在浏览器地址栏输入 url 按下回车之后会经历哪些流程：

1. 首先在浏览器地址栏输入 url 回车后，浏览器会先解析本地 DNS 配置，如果没解析域名对应 IP 地址，则继续向 DNS 域名解析服务器请求解析该 URL 中的域名所对应的 IP 地址;
2. 如果解析出了 IP 地址，则根据 IP 地址和端口号，向服务器建立连接（该过程也会涉及建立连接的三次握手），否则请求失败;
3. 浏览器向服务器端发出获取资源的 http 请求，其实就是请求 url 中域名后面对应部分的路径;
4. 服务器对浏览器请求做相应的处理，并将请求的资源响应发送给浏览器;
5. 然后根据 connection 中设置的值，来判断是否需要释放连接;
6. 浏览器获取到服务器端返回的资源，将相应的资源解析并渲染显示在浏览器页面。

上面说到的资源我们可以理解为请求需要的文件内容，比如浏览页面的 html 文件等。

简单的请求连接示意图如下所示：

![2](./images/8-2.png)

上图中的 web 服务器我们也称为 http 服务器，因为它主要是通过 http 协议与客户端进行通信；而客户端通常指的是浏览器了。我们可以看到，客户端需要先通过 DNS 服务器进行域名解析出相应的 IP 地址，再根据 IP 地址向 web 服务器发起请求，最后经过服务器端的处理及响应返回资源，客户端（浏览器）就可以将相应的资源渲染显示在浏览器页面了。

## 地址 URL 说明

## http 报文解析

客户端向服务器发送一个请求报文，请求报文包含请求的方法、URL、协议版本、请求头部和请求数据等。服务器以一个状态行作为响应，响应的内容包括协议的版本、状态码、服务器信息、响应头部和响应数据等。

#### 请求报文解析

#### 响应报文解析

## http 编程实现（基于 Go 语言实现）

#### http 服务端实现

#### http 客户端实现

## 实验总结

以上是基于 Go 语言实现并发通讯服务的案例。通过学习完本实验，大家可以知道如何用 Go 语言的 Socket 编程来实现多用户（客户端）进行通讯了，其实大家可以理解为一个聊天室。后续如果能力可以的话，大家可以在该基础上，用 redis 数据库替换以上说到的客户端全局队列，实现用户的登录、注册以及用户在线列表等，学会举一反三，达到学有所用的效果。本实验代码相对前面实验来说比较简洁，实现流程也比较简单，其中最经典、也最值得学习的就是 Go 语言的协程（Goroutine），希望同学们可以理解到协程使用的精髓。
